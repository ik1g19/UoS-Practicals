# Exploit Kits

Help deliver malware to visitors of websites

They bundle together exploits in commonly neglected software that users will have o Javascript in the browser
- Java (that's why it's always updating...)
- Adobe PDFs 

# Create a Honeypot

- Grab a domain name
- Use various emails at that domain name on various places and paste it in various public places
- Set up a mail server (I used sendmail)
- Set up all incoming email addresses to be piped to a script
- I wrote a simple script that processes any incoming email

It then grabs any received attachments, extracts them if they're compressed, and collects them into a folder
- Now you've got a folder of fresh malware!

# Types of Malware

Target
- Mass
- Specific (e.g. Stuxnet)

Forms
- Trojan Horse: Beware of Greeks...
- Virus: Spreading by host file
- Worm: Spreading by vulnerability

## Characteristics

### Information Stealing
Collect information from computer and send it to the attacker
Keyloggers: Actively recording everything typed
Sniffers: Monitor for anything that looks interested
Password stealers: Grab autocomplete and password information from web browsers and send them off
Intercepting: Browser extensions, proxy or similar technologies to intercept and manipulate web traffic
- Ebay, Amazon, your bank...

### Remote Access
Backdoor
- Allows an attacker remote access
- Commonly a remote shell

Botnet
- P2P networks, IRC, Twitter...
- Listen and wait for commands
- Download this
- Execute this
- Send data
- Send a photo from the webcam...

### Ransomware
- Hold all of your important files to ransom, only once it's too late
- Silently install, and start encrypting files in the background that you're not using
- Ideally, using asymmetric encryption, so you'd never have had the key on the system
- Once everything is encrypted, inform the user and demand money

### Scareware
Scare the user into thinking they have to pay to get their computer back

Disable general computer operation

### Rootkit
Hooking into operating system calls and changing their behaviour
- Conceal the payload
- If you can't see it, you can't easily remove it
	- Or even know it's there...
Common examples
- File and directory hiding
- Process hiding
- Registry hiding
- Falsified files
- Preventing applications from running
- Resisting removal

### Downloaders and Launchers
Specific standalone code to bundle other malware

Downloaders/Droppers
- Minimal applications whose sole goal is to download malware and execute it
Launchers
-  To launch other malware
-  Generally to make use of exploits and launch in a specific way
	- Bypassing UAC
	- Elevating to SYSTEM privileges
	- Other operating system exploits

# Malware on Windows

Portable Execute format (PE)

Linking
- Static: Code from library is in executable
- Dynamic: Imports listed, OS loads at start
- Runtime: Connect to libraries only when function needed

PE Header
- Information about the entire file
- Type of code
- Flags (e.g. executable, DLL)
- Linking information
- Size and memory information

## PE Sections

- PE file made up of sections
- Sections have names, flags (e.g. executable) and content
- Typical layout:
	- .text
		- Instructions - what the CPU executes
		- Contains the executable code
	- .rdata
		- Imports and exports
	- .data
		- Global data for the program
	- .rsrc
		- Resources used by the program (e.g. icons, dialogs, strings)

## PE Execution

- Extract entry point, heap and stack sizes from PE header
- Iterate through sections and load into virtual memory
- Find address of entry point from symbol table
- Load imports
- Create a new thread at that address, and execute

## Linking Information

### Imports
- What will be called outside
- DLLs - libraries of functions that you can use
- You will get used to seeing certain DLLs
	- Kernel32.dll - Core functionality (memory, files, hardware)
	- Advapi32.dll - Windows components (service manger, registry)
	- User32.dll - User interface components
	- Gdi32.dll - Display
	- Ntdll.dll - Interface to windows kernel
	- WSock32.dll/WS2_32.dll - Winsock (network)
	- Wininet.dll - High level networking functions

### Exports
- What can be called inside
	- Dllmain

# Common Techniques

## Persistence

Malware generally needs to persist between system boots
- Although becoming less important these days with "always-on" systems

How can they make sure they load each time?
- Logon (Shell, Run)
- Explorer hooks
- Scheduled tasks
- Services
- Drivers
- Boot execute
- AppInit (DLL loaded into every application that starts)

Generally: Remove their persistence, remove the malware

### Evasive Technqiues
If the malware is running
- Make it hard to stop the Malware once it is running
- Prevent removing/changing the persistence
- Hide the presence of persistence (Rootkit behaviour)

RunOnce
- Every boot, the malware is loaded from the RunOnce key, then removed - but it's in memory
- No tools will show it as being persistent anywhere, as the RunOnce key is no longer populated
- On a clean shutdown, write back to the RunOnce key
- Solution: Don't clean shutdown!

## Stealth

Camouflage against legitimate system files
- Check digital signatures

Pretend to be Microsoft
- Call your things stupid names, like KB138719.exe as a Windows update and put it in the updates folder... Nobody will ever suspect!

Inject into other processes
- Nobody would ever expect explorer.exe

Replace legitimate files
- Legitimate + a little bit extra

Hiding from the operating system
- Rootkit time!

Replace things that don't get used often
- Goodbye calculator... Until next time!

## Packing and Obfuscation

Take an application, then pack it inside a wrapper application
- When the application is run, the inner application is unpacked into memory and executed

When you try to inspect the application, you only see the wrapper
- Makes static analysis harder
- Can't look at the application and work out what it does

But ultimately, it needs to be unpacked at some point...

# Malware Analysis

Basic analysis
- Basic static analysis
	- Analysing without running
	- Does it look suspicious?
	- What should it do?
	- Basic dynamic analysis
	- Analysing it in it's natural habitat
	- What does it do?

Advanced analysis
- Advanced static analysis
- Reverse engineering the code
- Advanced dynamic analysis
- Real-time debugging

## Anti-Analysis

Detect the presence of Virtualization
- Behave differently
- Don't behave at all!

But how does it work?
- Look at the drivers
- Look at the virtualized devices
- Look for the virtualization support software
- Look for analysis tools
- Networking
- Look for any other signs (low RAM, low hard drive size etc.)
- Measure time access to System RAM, Caches,..

What do they often do?
- Self destruct!
- DDoS

Certain packers/wrappers - e.g. VMDetect
- Make it easy for people to protect their malware against detection
- However, make it easier for people to try to bypass a standard set of code

## Basic Static Analysis

- Examine the PE file itself
- Signature: What was it compiled with?
- Structure: Is it packed?
- Sections: How is the file made up?
- Metadata: What other information is there?
- Certification: Has the file been digitally signed?
- Imports: What does it use?
- Exports: What does it make available?
- Strings: What text does it contain?
- Resources: What icons, menus, dialogs does it have?

### Signature and Structure

#### Detect it Easy
- Helps you before you try to do static analysis o For example, working out how to unpack it, if you can
- Uses signatures for PE information

- Various PEInfo tools
- Work out what an application is packed with
- Work out what an application was compiled with
- Other information about the application

![|400](notes/Software%20Security/Images/Pasted%20image%2020230412212723.png)

#### Examining the PE File
The Portable Executable (PE) file format is used by Windows executables, object code, and DLLs

The PE file format is a data structure that contains the information necessary for the Windows OS loader to manage the wrapped executable code

The information in the PE can provide valuable information to the malware analyst

Use DependencyWalker and Peview to examine a PE file

#### PE File Structure
##### Header
Stores information about every library that will be loaded and every function that will be used by the program

| Field | Information Revealed |
| :--- | :--- |
| Import | Functions from other libraries that are used by the malware |
| Export | {:[" Functions in the malware that are meant to be called by other "],[" programs or libraries "]:} |
| Time Data Stamp | Time when the program was compiled |
| Sections | Names of sections in the file and their sizes on disk and in memory |
| Subsystem | Indicates whether the program is a command-line or GUI application |
| Resources | Strings, icons, menus, and other information included in the file |

##### Sections
`.text` - Contains the executable code

`.rdata` - Holds read-only data that is globally accessible within the program

`.data` - Stores global data accessed throughout the program

`.rsrc` - Stores resources needed by the executable

#### Packing and Obfuscation
Is it packed?
- Barely any imports
- No useful strings
- Non-standard names of sections
- Section specifications
- Section contains code
- Section can be executed as code
- Size differences
- Two main functions
	- LoadLibrary
	- GetProcAddress
- Other functions
	- Functions which work with virtual memory
	- Functions to work with libraries

Is it obfuscated?
- No useful names
- Conventions not adhered to
- No useful strings

![|400](notes/Software%20Security/Images/Pasted%20image%2020230412213223.png)

##### If it is packed
You'll want to unpack it first before doing analysis!

Various different packers

Some can be easily unpacked
- UPX: Automatic pack and unpack utility

Some are harder to unpack
- Manually extract the inner application
- Follow the tail jump

Some are nearly impossible to unpack
- Attempt to dump the process from memory

### Sections and Metadata

#### PEStudio
Allows us to see what sections an executable has

Allows us to take a peek inside

Gives lots of other very useful information!

Inspects the PE and information inside, including strings and imports and exports Tells you if there's anything that is likely to be suspicious

Helps filter out the legitimate from the illegitimate

Easier to determine if something is suspicious!

![|400](notes/Software%20Security/Images/Pasted%20image%2020230412213434.png)

### Metadata and Ceritfication

Has the file got version information

Has the file been digitally signed

Common indicators as to whether is it legitimate

![|800](notes/Software%20Security/Images/Pasted%20image%2020230412213536.png)

### Imports and Exports

#### Dependency Walker
**Imports**: What functions does the malware use
- Only includes those directly accessed

**Exports**: What functions does the malware make available - when the malware isn't a single file
- But they probably won't be helpfully named

Dependency walker breaks this down for us

![|400](notes/Software%20Security/Images/Pasted%20image%2020230412213646.png)

#### Common DLLs
| DLL | Description |
| :---: | :---: |
| Kernel32.dll | This is a very common DLL that contains core functionality, such as access and manipulation of memory, files, and hardware. |
| Advapi32.dll | This DLL provides access to advanced core Windows components such as the Service Manager and Registry. |
| User32.dll | This DLL contains all the user-interface components, such as buttons, scroll bars, and components for controlling and responding to user actions. |
| Gdi32.dll | This DLL contains functions for displaying and manipulating graphics. |
| Ntdll.dll | This DLL is the interface to the Windows kernel. Executables generally do not import this file directly, although it is always imported indirectly by , Kernel32. dll. If an executable imports this file, it means that the author intended to use functionality not normally available to Windows programs. Some , tasks, such as hiding functionality or manipulating processes, will use this interface. |
| WSock32.dll and Ws2_32.dll | These are networking DLLs. A program that accesses either of these most likely connects to a network or performs network-related tasks. |
| Wininet.dll | This DLL contains higher-level networking functions that implement protocols such as FTP, HTTP, and NTP. |

#### Exmaples of Imported Functions
`OpenProcess`, `GetCurrentProcess`, and `GetProcessHeap`
- open and manipulate processes

`ReadFile`, `CreateFile`, and `WriteFile`
- open and manipulate files

`FindFirstFile` and `FindNextFile`
-  search through directories

### Strings
Simple tool - find all the strings that are accessible in the file

Tells you functions that it calls

Tells you domains that it tries to connect to

Tells you information that may be displayed in the UI Sometimes contains fun messages from the malware authors!

### Resources

#### Resource Hacker
View the sections inside the aplication

View the resources that are associated with it

Inspect any images, icons, dialogs and other resources inside

If the application has a GUI, gives you an idea as to what it does

## Advanced Static Analysis

What is it doing, in what order, and how and when

### IDA

Taking the malware on the disk in binary form and disassembling it into assembly code
- We can then explore the assembly code to learn what it is doing
- All still without running it!

We have to work with the assembly instructions
- The "human readable" version of machine code
- Low level
	- Registers, memory, CPU instructions
-  It's not easy!
	- But we don't need to understand everything, just the bits that are most interesting to us
	- Know when to give up!

#### Graph and Text Mode
![|400](notes/Software%20Security/Images/Pasted%20image%2020230412214554.png)

#### Functions
Shows each function, length and flags
- L = Library functions

Sortable
- Large functions usually more important

![|600](notes/Software%20Security/Images/Pasted%20image%2020230412214649.png)

#### Names Window
Every address with a name
- Functions, named code, named data and strings

![|400](notes/Software%20Security/Images/Pasted%20image%2020230412214734.png)

#### Strings
![|400](notes/Software%20Security/Images/Pasted%20image%2020230412214801.png)

#### Imports and Exports
![|400](notes/Software%20Security/Images/Pasted%20image%2020230412214823.png)

#### Structures
All active data structures
- Hover to see yellow pop up window

![|600](notes/Software%20Security/Images/Pasted%20image%2020230412214856.png)

#### Function Call
Parameters pushed onto stack

Call to start function

![|600](notes/Software%20Security/Images/Pasted%20image%2020230412214932.png)

#### Jump to Location
Press 'G'
Can jump to address or named location

![|400](notes/Software%20Security/Images/Pasted%20image%2020230412215010.png)

#### Function and Argument Recognition
IDA identifies a function, names it and also names the local variables

It is not always correct

![|600](notes/Software%20Security/Images/Pasted%20image%2020230412215058.png)

